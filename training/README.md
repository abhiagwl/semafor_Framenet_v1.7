# SEMAFOR training

This is a README for training on the FrameNet 1.7 full text annotations which refers to [Noah's training readme file](https://github.com/Noahs-ARK/semafor/tree/master/training).

Yang Gao, yxg122530@utdallas.edu, 07/05/2017.

Training models for frame-semantic parsing with SEMAFOR is a very laborious and 
time-consuming. Your kind patience is required to train the models.

### Checkout the code:

```
git clone git@github.com:Noahs-ARK/semafor.git
cd semafor
```

Modify the variables in `./bin/config.sh` as needed.

Run:

```
mvn package
```

Make sure you have the required data.
You can download FrameNet 1.7 [here](https://utdallas.box.com/s/ma5s14qf9aphes5d2hro7d5x9q98g3zx), but
also please fill out the request form [here](https://framenet.icsi.berkeley.edu/fndrupal/framenet_data)
if you haven't already.
Set the `luxmldir` environment variable in `training/config` to point at the `lu` folder.
The train/dev/test splits that were used in the NAACL '12 and subsequent papers can be found
[here](http://www.cs.cmu.edu/~ark/SEMAFOR/naacl2012_splits_with_rank_score.tar.gz).


### 1. Data structure preparation 1/2

Used to train and test the frame identification and argument identification models (please refer to [NAACL 2010 paper](https://homes.cs.washington.edu/~nasmith/papers/das+schneider+chen+smith.naacl10.pdf) to understand these two steps). The first step is to create two maps --  `framenet.original.map` and `framenet.frame.element.map`.
  1. The first map is of type `THashMap<String, THashSet<String>>`. It maps a frame to a set of disambiguated predicates (words along with part of speech tags, but in the style of FrameNet).
  2. The second map is of type `THashMap<String,THashSet<String>>`, which maps each frame to a set of frame element names. In other words, this data structure is necessary for the argument identification model to know what the frame elements are for each frame.

My versions of these two maps are present in semafor/SemaforMap/output/ directory (these are just serialized Java objects). 
Use the `semafor-deps.jar` file in `lib/` directory  to get the right version of GNU trove, and read (deserialize) these two maps. After that print the keys, and the corresponding values to see exactly what is 
stored in these maps. After that, you will need to create your own versions of these two maps for your domain, in exactly the same format as these maps. If you want existing code in SEMAFOR to create these maps, you could use the method `writeSerializedObject(Object object, String outFile`) in [SerializedObjects.java](https://github.com/sammthomson/semafor/blob/master/src/main/java/edu/cmu/cs/lti/ark/util/SerializedObjects.java) to write serialize those maps. So creating your own maps will be easy. You could also read the maps using that class.

For your convenience, I provide my code that generates these two maps in SemaforMap/ folder. In my case, I simply add "Protest" related frames and lexical units into these 2 maps. You may add more if you prefer.

### 2. Data structure preparation 2/2

Used for training and inference procedure.
```
./training/2_createRequiredData.sh
```
Always make sure you run that ```java``` program in this shell script. Check if ```ln``` command is commented while configuration and ```java``` program is uncommented. This is very important since files generated by this step are going to be used by follwing shell scripts. (The original author use ```ln``` for simplicity and speed reason but you should never use that unless you fully understand it)

### 3. Training the frame identification model

 `./training/trainIdModel.sh` consists of:

1. alphabet creation and combination:
  ```
  ./training/3_1_idCreateAlphabet.sh
  ```
  This takes ~1 min using 8 threads (AMD Opteron(TM) 6272 2.1MHz processors; using the "ancestor" model).

2. creating feature events for each datapoint:
  ```
  ./training/3_2_idCreateFeatureEvents.sh
  ```
  Takes ~3-4 minutes.

3. training the frame identification model:
  ```
  ./training/3_3_idTrainBatch.sh
  ```
  Takes ~40 minutes.
  Line search in L-BFGS may fail at the end, but that does not mean training failed. 
  In models_0.0, there will be models produced every few iterations. If line search failed, take the last model.

4. convert the alphabet file:
  ```
  ./training/3_4_idConvertAlphabetFile.sh
  ```
  Takes <1 minute.

### 4. Training the argument identification model

`./training/trainArgModel.sh` consists of:

1. alphabet creation:
  ```
  ./training/4_1_createAlphabet.sh
  ```
  Takes ~7 minutes.

2. caching feature vectors:
  ```
  ./training/4_2_cacheFeatureVectors.sh
  ```
  Takes ~10 minutes.

3. training:
  ```
  ./training/4_3_training.sh
  ```
  Takes ~ a day (in my case, it takes about 26 hours).
  This step has a regularization hyperparameter, lambda. You may tune lambda on a development set to get the best results.
 Â Note in this step, line search in L-BFGS may fail at the end, but that does not mean training failed. Check function values that is print out at each iteration, if it does not change significantly, you may simply take the last generated model written to ```$data_dir$``` and copy it to your model destination folder. However, since intermediate model files have the name format ```argmodel.dat_xxx``` where ```xxx``` is a number, you need to change its name to ```argmodel.dat```. 
  
  In my case, it has little effect on the performance. 

### 5. Final Steps

1. copy ```engmalt.linear-1.7.mco``` from ```models``` directory provided by author to your model destination folder.

2. copy ```parser.conf.unlabeled``` from ```your model destination folder/scan``` to ```your model destination folder``` and rename it as ```parser.conf```

3. copy ```framenet.frame.element.map``` you generated to your model destination folder

4. copy ```sparsegraph.gz``` from ```models``` directory provided by author to your model destination folder.

5. change the environment variable ```MALT_MODEL_DIR``` to point to your new model directory
